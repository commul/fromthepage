=render({ :partial => '/shared/page_tabs', :locals => { :selected => 3, :page_id => @page.id }})

-editor_class = 'page-editor' + (@auto_fullscreen == 'yes' ? ' fullscreen' : '')

=form_for(@page, :url => { :action => 'save_transcription' }, :html => { class: editor_class, :onsubmit=>'return AddMediumValue()' }) do |f|
  =hidden_field_tag(:page_id, @page.id)
  <input type="hidden" name="page[source_text]"/>
  =validation_summary @page.errors
  .page-toolbar
    .toolbar

      .toolbar_group
        a.button.outline(data-fullscreen-toggle) Fullscreen
      .toolbar_group
        -layout_modes = { 'ltr' => 'Image at the left', 'rtl' => 'Image at the right', 'ttb' => 'Image at the top', 'btt' => 'Image at the bottom' }
        dl.dropdown.page-columns-layout(data-dropdown='{ "selectable": true }')
          dt.button.outline
            =svg_symbol "#icon-layout-#{@layout_mode}", class: 'icon'
            span.hide-l =layout_modes[@layout_mode]
          dd
            -layout_modes.each do |mode, text|
              a(data-layout-set="#{mode}")
                =svg_symbol "#icon-layout-#{mode}", class: 'icon'
                span =text
      .toolbar_group.hide-m
        label.auto-fullscreen
          =check_box_tag 'auto-fullscreen', 'yes', @auto_fullscreen == 'yes'
          |&nbsp;
          span Always show in fullscreen

      .toolbar_group.w100.aright
        -unless @page.status == 'blank'
          span Mark page as blank
          |&nbsp;
          =check_box_tag 'mark_blank', 'yes'
        -else
          span Page is not blank
          |&nbsp;
          =check_box_tag 'mark_blank', 'no'
      .toolbar_group.w100.aright
        span Page Needs Review
        |&nbsp;
        -if @page.status == 'review'
          =f.check_box('needs_review', {checked: true})
        -else
          =f.check_box('needs_review', {checked: false})
      .toolbar_group.w100.aright
        =button_tag 'Save Changes', :name => 'save'


  .page-columns(data-layout-mode="#{@layout_mode}" data-fullheight='{ "bottom": 30, "cssrule": "height" }')
    .page-column
      .page-imagescan
        -if @page.ia_leaf
          =render :partial => '/ia/ia_bookreader_div'
        -elsif @page.sc_canvas
          =render :partial => '/shared/iiif_div'
        -elsif @page.omeka_file
          =render :partial => '/shared/zoom_div', :locals => { :fullsize_url => @page.omeka_file.fullsize_url }
        -else
          =render :partial => '/shared/zoom_div'
    .page-column
      -if @page.status == 'blank'
        .centered
          .centered_content
            p.nodata_text=="This page is marked blank"
        .page-editarea(style=("display:none"))
          =f.text_area :source_text

      -else
        .page-column_actions
          -unless @preview_xml
            =>button_tag 'Preview', :name => 'preview'
          -else
            =>button_tag 'Edit', :name => 'edit'
          -unless @collection.subjects_disabled
            =>button_tag 'Autolink', :name => 'autolink'
        -if @preview_xml
          .page-preview ==xml_to_html(@preview_xml)

        .page-editarea(style=("display:none" if @preview_xml))
          -if @work.scribes_can_edit_titles
            .page-editarea_title
              span =f.label :title, 'Title:', class: 'a50'
              span =f.text_field :title
          .card*{'id'=>'page_source_text', 'contenteditable'=>'true'}
            = @page.source_text

<div class="popupBody">
<p>Select your offer:</p>
<select class="chosen-select-no-results">
  <option></option>
  <option value="greeting" disabled="disabled">greeting</option>
  <option value="closing">closing</option>
  <option value="hyphen">hyphen</option>
  <option value="tre">tre</option>
</select>
</div>

<div class="toolbar-top">
  <span class="toolbar">
    <span class="bold" style="font-weight: bold; color: #66d9ef">B</span>
    <span class="underline" style="text-decoration: underline; color: #a6e22e">U</span>
    <span class="italic" style="font-style: italic; color: #f92672">I</span>
    <span class="strike" style="text-decoration: line-through; color: #0606ee">S</span>
    <span class="hyphen" style="color: #0606ee">hyphen</span>
    <span class="closing" style="color: #ee0606">closing</span>
  </span>
</div>

.fgfaded ==@work.set_transcription_conventions

.fgfaded
  =render :partial => 'shared/markup_help'

h2.legend Page Notes
.page-notes
  =render :partial => "notes/notes"


-content_for :javascript
  javascript:
    $(function() {
      $('[data-fullscreen-toggle]').on('click', function() {
        $(this).toggleClass('pressed');
        $('.page-editor').toggleClass('fullscreen');
        $(window).trigger('resize.FullHeight');
        $('.zoomer-container').zoomer('resize');
      });
      $('[data-layout-set]').on('click', function() {
        var mode = $(this).data('layout-set');
        Cookies.set('transcribe_layout_mode', mode, { expires: 365 });
        $('[data-layout-mode]').attr('data-layout-mode', mode);
        $('.zoomer-container').zoomer('resize');
      });
      $('#auto-fullscreen').on('change', function() {
        var checked = this.checked ? 'yes' : 'no';
        Cookies.set('auto_fullscreen', checked, { expires: 365 });
      });


      

    });

      
      var l=document.getElementById('page_source_text');
      console.log("l : "+l);
      console.log("l.textContent : "+l.textContent);

      var xml=l.textContent;
      //xml = xml.replace(/(<br><\/br>)$/, '<br>\&#160\;<\/br>'); //Ne remplace rien
      console.log("xml : "+xml);
      xml = "<div>"+xml+"</div>";
      //xml = xml.replace(/<\/br>/g, '');  // Esli dobavliaiu eto, to oshibka parsinga i voobshe nichego ne pokazyvaet v Transcribe
      //xml = xml.replace(/&nbsp\;/g, '');
      //var result = $(xml).find("album").text();
      //console.log("result : "+result);
      //var el_result=$(xml).find("closing").text();
      //console.log("el_result : "+el_result);
      var parser = new DOMParser();
      var doc = parser.parseFromString(xml, "text/xml");
      //var allDocContent=doc.documentElement.innerHTML;
      var childNodes=doc.documentElement.childNodes;
      var childNodes2=doc.childNodes;
      var allDocContent=doc.childNodes[0];
      var docChildNode=doc.documentElement.childNodes[0];
      //var article=document.getElementById('page_source_text');
      var article=l;
      var firstChild=article.firstChild;
      //console.log("article.firstChild : "+article.firstChild);
      firstChild.parentNode.replaceChild(allDocContent,firstChild);

      var closingElement=article.getElementsByTagName('closing')[0];

        var container = article.parentNode,
        medium = new Medium({
            element: article,
            mode: Medium.richMode,
            attributes: null,
            placeholder:"",
            tags: null,
            pasteAsText: false,
            beforeInsertHtml: function () {
            //console.log("in display_page in medium constructor in beforeInsertHtml");
              //this = Medium.Html
            },
            onFocus: function () {
              //moveCursorToEnd(this);
            }
        });
        

      /*
      $(document).ready(function() {
        $('#page_source_text').wymeditor();
      });
      */

      $(".popupBody").hide();

      var config = {
      '.chosen-select'           : {},
      '.chosen-select-deselect'  : {allow_single_deselect:true},
      '.chosen-select-no-single' : {disable_search_threshold:10},
      '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
      '.chosen-select-width'     : {width:"95%"}
    }
    for (var selector in config) {
      $(selector).chosen(config[selector]);
    }

    $(".chosen-select-no-results").chosen();



      //originalForm
      jQuery('#page_source_text').bind('keydown', 'alt+o', function(e) {  
        // right arrow key pressed
        alert("alt+o");
        medium.focus();
        //medium.addTag($tag);
        //medium.insertHtml('<p class="originalForm">\originalForm\</p>');
        medium.insertHtml('<p class="originalForm">\originalForm');
        return false;
      });


      jQuery.fn.chosen_reset = function(n){
        $(this).chosen('destroy');
        $(this).prop('selectedIndex', 0);
        $(this).chosen(n)
      }

      //targetForm
      jQuery('#page_source_text').bind('keydown', 'alt+g', function(e) {
        //medium.splitAtCaret(); //ostavliaet tolko to, chto do kursora, ostalnoe udaliaet
        var offset=medium.returnOffset()[0];
        var focusEl=medium.returnOffset()[1];
        console.log("offset : "+offset);
        //baseAtCaret
        //var input = $('#page_source_text').get(0);
        //console.log("input.selectionStart; : "+input.selectionStart);
        var value=$('#page_source_text').value;
        $(".popupBody").show();
        
        var enableChosen = setTimeout(function() {
          $(".chosen-select-no-results").trigger('chosen:activate');
        }, 250);

        $(".chosen-select-no-results").chosen().change(function(event){
          if(event.target == this){
              //alert($(this).val());
              $tag=$(this).val();
              if($tag!= null && $tag!=''){
                //$(".chosen-select-no-results").trigger('chosen:updated');
                //$(".chosen-select-no-results").focus().val($(".chosen-select-no-results").val());
                //('#page_source_text').focus();
                //moveCursorToEnd($("#page_source_text"));
                //medium.focus();

                medium.focusNadya(offset,focusEl);
                console.log("$tag : "+$tag);
                //medium.caretToEnd();
                //medium.moveCursorToEnd();
                //medium.splitAtCaret();
                //medium.paste($tag);
                //medium.addTag($tag);
                medium.insertHtmlNadya($tag, offset, focusEl);
                //medium.insertHtml($tag);
                //medium.paste($tag);
                $('.chosen-select-no-results').chosen_reset(config);
                $(".popupBody").hide();
                
                console.log("medium.value() : "+medium.value());

                return false;
              }
          }

        });

        return false;
      });


    article.highlight = function() {
      if (document.activeElement !== article) {
        medium.select();
      }
    };

    $( ".bold" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('b', {
        title: "here bold",
        style: "color: #66d9ef"
      });
      return false;
    });

    $( ".underline" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('u', {
        title: "here underlined",
        style: "color: #a6e22e"
      });
      return false;
    });

    $( ".italic" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('i', {
        title: "here italics",
        style: "color: #f92672"
      });
      return false;
    });
  
    $( ".strike" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('strike', {
        title: "here struck",
        style: "color: #0606ee"
      });
      return false;
    });

    $( ".hyphen" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('hyphen', {
        title: "here hyphen",
        style: "color: #0606ee"
      });
      return false;
    });

    $( ".closing" ).mousedown(function() {
      article.highlight();
      medium.invokeElement('closing', {
        title: "here closing",
        style: "color: #ee0606"
      });
      return false;
    });

    function AddMediumValue() {
        mediumValue = medium.value();
        mediumValue = mediumValue.replace(/\&nbsp\;/g, '\&#160\;');
        mediumValue = mediumValue.replace(/<br>/g, '<br></br>');
        mediumValue = mediumValue.replace(/<\/br><\/br>/g, '</br>');
        mediumValue = mediumValue.replace(/^<div>/, '');
        mediumValue = mediumValue.replace(/<\/div>$/, '');
        document.getElementsByName("page[source_text]")[0].value=mediumValue;
        return true;   // Returns Value
      }
javascript:  mixpanel.track("Transcribe Page");
